import log1pmx from './log1pmx';
import frexp from './frexp';
import ldexp from './ldexp';

const bd0_scale: readonly [number, number, number, number][] = [
  [0.69314718246459961, -1.9046542121259336e-09, -8.7831837385893394e-17, 3.0618407385293692e-24],
  [0.68530404567718506, -4.2578264469739224e-08, -1.1723105396588968e-15, 6.2033926372016101e-23],
  [0.67739880084991455, 2.2741890148836319e-08, 1.4411920431605914e-15, 7.0463845466501636e-23],
  [0.66993057727813721, -4.8293856025338755e-08, -8.6647955317383819e-16, 7.0495576607553246e-24],
  [0.66240608692169189, -4.7916024925598322e-08, -2.161508226230938e-15, 7.0929683608252748e-23],
  [0.65482449531555176, 6.2377152332260266e-09, 1.1806699607549086e-16, 6.6603235335351226e-25],
  [0.64718508720397949, -4.2208668560306251e-08, -1.3817589176253094e-15, -1.1159932395766606e-23],
  [0.64000189304351807, -4.9791701428603119e-08, 4.8870137639076255e-16, 1.6847465694533583e-23],
  [0.6327667236328125, -5.4061771947999659e-08, -2.7224545250006775e-15, -2.9070780223955397e-23],
  [0.62495613098144531, 3.285935434860221e-08, 1.2016729367754671e-16, -8.668233185091897e-24],
  [0.61813735961914062, -6.4061894677891473e-11, 3.5505809623358779e-18, -3.6236794067489652e-25],
  [0.61074161529541016, 4.2298538005525188e-08, 1.5481432935203661e-15, -5.4463531187197656e-23],
  [0.60329079627990723, 5.5158174916414282e-08, 2.1193636784238266e-15, 1.2471098264106631e-22],
  [0.59632217884063721, 3.2813538553000399e-09, -1.4033469816541837e-16, 5.5440619826430738e-24],
  [0.58930456638336182, 4.3079985800886789e-08, -3.2446651600595306e-15, -2.569782398567476e-23],
  [0.58223748207092285, -3.983067387025585e-08, 2.9387905513776885e-15, 1.6124430498687833e-22],
  [0.57511997222900391, 2.2423840562169062e-09, -2.2045164035371139e-17, 4.0785437537513542e-25],
  [0.5685046911239624, 4.4228706030935427e-08, 2.7879957109977287e-16, -9.7417087940294081e-24],
  [0.56184542179107666, 2.1471613820267521e-08, 1.3374919170106156e-15, -2.3269222603365059e-23],
  [0.55458080768585205, 4.5778349999636703e-09, 2.6331459121410258e-16, 2.0709959033879981e-23],
  [0.54782783985137939, -7.6679995686390612e-09, 6.1990953277753225e-16, 6.3419790110560228e-24],
  [0.54102897644042969, -3.7302321231891256e-08, -3.3801781496424835e-15, 1.4469198371142414e-22],
  [0.53475570678710938, 4.3828919160660007e-08, -8.6018207496923928e-16, -8.7759505639780158e-24],
  [0.52786707878112793, 1.0839714903454478e-08, -4.4802812481303193e-16, 3.8840996084516777e-23],
  [0.52151048183441162, 4.2031594205127476e-08, 1.211009992711288e-15, -2.3206744819671555e-23],
  [0.51452970504760742, -1.2322940889930578e-08, 2.8200844954132738e-16, 1.880026562185923e-23],
  [0.50808751583099365, -1.2297126872340414e-08, -4.2958355887009591e-16, -1.8036626177499945e-23],
  [0.50160348415374756, 5.9145378372704727e-08, 1.2728561033550608e-15, -5.8240944300194158e-23],
  [0.49507725238800049, 1.4409851090135817e-08, -6.3819101840834221e-17, -3.5005093767171181e-25],
  [0.48910707235336304, 2.7457986107037868e-08, -1.4470418644525664e-15, 4.2118668969499388e-23],
  [0.48249846696853638, 1.7622454606680549e-08, 4.128675224747099e-16, 2.6082691866392177e-23],
  [0.4764525294303894, -1.2470243504481004e-08, -9.1621939247941964e-17, 3.7657825422403758e-24],
  [0.46975946426391602, -5.4503539459460626e-09, -4.3048469604685608e-16, 2.0747103437070831e-25],
  [0.46363574266433716, -1.7013046527125653e-09, 7.6016227388785886e-18, -2.0415879231895994e-25],
  [0.45747429132461548, 6.9436845162584859e-10, -2.5461310777374286e-17, 5.5412533419976475e-25],
  [0.45127463340759277, 1.0731865174307131e-08, 6.374000219845047e-16, 3.9015473184089939e-23],
  [0.44503629207611084, 2.8650656958006948e-08, -9.1553525455583418e-16, -4.7365878254772817e-23],
  [0.43938833475112915, 2.6186132373595683e-08, 1.3619601577579505e-15, -5.2672794844240613e-23],
  [0.4330751895904541, 1.9065733880552216e-08, 1.0143192014799461e-15, 1.0145670737413337e-22],
  [0.42735910415649414, -1.141359362577532e-08, 1.3242044582274781e-16, -1.0240055893684678e-23],
  [0.42096930742263794, -1.2778508917676845e-08, 6.1435257312707041e-16, 1.419242178938019e-23],
  [0.41518336534500122, -7.7679160881416465e-09, 5.9554431241240708e-16, 2.732668133771502e-23],
  [0.40936374664306641, 1.8807551072086426e-09, 1.9153331349462894e-16, -5.6208063158074999e-24],
  [0.40351009368896484, -2.0416603518924603e-08, -2.9340501314883798e-16, 1.8943469119705811e-24],
  [0.39762192964553833, 1.0016001361634608e-09, 2.2863242352463633e-17, 9.4581336117707638e-25],
  [0.39169889688491821, 1.5459097113534881e-08, 1.0962823446210085e-15, 3.1083022398211258e-23],
  [0.38640439510345459, -2.076412375373593e-09, 1.5073464810114547e-16, 7.4124494543750944e-24],
  [0.38041436672210693, -8.2443953886013333e-09, 1.4866224964678982e-16, -3.9272927406839679e-24],
  [0.37438821792602539, 9.1585299344387749e-09, 5.6569190673585014e-16, 3.4213474905617904e-23],
  [0.36900103092193604, -2.2253590969967263e-08, 6.2314053995483377e-16, -2.1564751355837555e-23],
  [0.36358463764190674, -2.6778728567933285e-08, -9.9439084557165734e-16, -4.7049297329454952e-24],
  [0.35745590925216675, -2.0330361394371721e-08, -1.5794492077344114e-15, 6.3186780320680572e-23],
  [0.35197639465332031, 2.8503858828798911e-08, -9.5664345755197989e-16, -6.409595040255684e-24],
  [0.3464667797088623, -1.236265312343221e-08, -6.0033682482797191e-16, -2.8609014971057941e-24],
  [0.34092658758163452, -6.1104132864642224e-10, 1.7467136243918857e-17, 1.9962587429804357e-25],
  [0.33535552024841309, 2.167272583619706e-08, -1.0918773497788125e-15, -3.0475747807041261e-23],
  [0.33045530319213867, -1.6088840482098021e-08, -3.8334350088389162e-16, -7.6837418751242213e-24],
  [0.32482540607452393, 2.8016703623734429e-08, -2.0725720961098414e-16, 1.3160777896524739e-23],
  [0.31916368007659912, 2.6222629401218001e-08, -1.3995222573204161e-15, 8.5998839096808329e-23],
  [0.31418323516845703, 2.6826626253750874e-08, -9.7925563735364388e-16, 2.2954960929108544e-23],
  [0.3084607720375061, 1.3683509436646091e-08, 5.5919950507426434e-16, -1.1938701403427125e-23],
  [0.30342662334442139, -8.6290423695345453e-09, -5.2225542192593918e-16, 3.228770766379237e-23],
  [0.2983669638633728, 8.6884242023188563e-09, 2.7641167934234459e-16, -1.0171858868428321e-23],
  [0.29255300760269165, -4.9163144666408698e-09, 2.5622847239605072e-16, -2.6341575505102177e-23],
  [0.28743791580200195, -1.3782395669181824e-08, 7.2903935187764498e-16, -4.4319779432822359e-24],
  [0.28229647874832153, 2.3770866164340987e-08, 6.4492283922642536e-16, 3.4175369768452108e-23],
  [0.27712851762771606, 1.4733029018998423e-08, 6.793364114448283e-16, 3.5938980340322221e-24],
  [0.27193373441696167, -1.8933320689029642e-08, 7.7793941095558299e-16, 2.5919724247426189e-23],
  [0.2667117714881897, 1.4300387263244119e-11, -7.458876800955772e-19, 4.247418782257993e-26],
  [0.26221400499343872, 7.8022193150673047e-09, 5.0224310387675386e-16, -2.4063174816868367e-23],
  [0.25694090127944946, 2.9618050234603288e-08, 7.2795282036455453e-16, 2.638556081145549e-23],
  [0.25163990259170532, -6.4478777872523096e-09, 4.1220281336935209e-16, 7.4275592961536977e-24],
  [0.24707368016242981, -1.9981829524340355e-09, -1.0909757890855787e-16, 6.2365520898082133e-24],
  [0.24171993136405945, 5.5230859885568862e-09, -2.6865476336962652e-16, -2.7644959891700921e-24],
  [0.23710808157920837, 1.0085374313462125e-08, -4.7756268137613168e-16, 2.3306205980323631e-23],
  [0.231700599193573, -1.3946383603524737e-08, 1.0970921279709183e-17, 3.229909378627549e-25],
  [0.22704219818115234, -6.4512848396702793e-09, -4.2529947798112047e-16, -1.0260254677162862e-23],
  [0.2223619818687439, 1.4110645096820917e-08, 6.0255689818272543e-16, 1.9385180739531644e-23],
  [0.21765980124473572, -8.286782815503102e-09, 5.2323639195797807e-16, 5.0784435386540659e-23],
  [0.21214580535888672, -8.2542186419232166e-09, 3.2555531333217742e-16, 1.5714300136341619e-23],
  [0.20739519596099854, -1.6149279691290985e-09, 2.1131592679643073e-17, 1.4275617427027514e-24],
  [0.20262190699577332, 8.5976399333276277e-09, -3.3804619056798137e-16, 2.5623235609364303e-24],
  [0.19782572984695435, 1.348296585490516e-08, -3.2024568730231384e-16, -2.5712252251631252e-23],
  [0.19300645589828491, 9.9568597811128257e-10, 9.0016745638446061e-17, -3.7547976541351732e-24],
  [0.18897256255149841, 4.2415360113068346e-09, 3.8086815297465933e-16, -2.1147402916208568e-23],
  [0.18411031365394592, 6.9310548411749551e-09, -3.4784858522920016e-16, 2.4665943434547742e-23],
  [0.17922431230545044, 5.0739235035734964e-09, 3.2221329189922637e-16, -1.0379009008973928e-23],
  [0.17431432008743286, 3.7943852504440656e-09, 3.1900668985871761e-16, 2.0292714723890484e-23],
  [0.17020416259765625, 3.4223344158590407e-09, -1.8846416901959178e-16, 1.1415315069779235e-23],
  [0.16524958610534668, -1.3210039284672348e-08, -2.3213954359040806e-16, 3.0430542132867571e-24],
  [0.16027030348777771, 6.0079221597675314e-09, -7.5210477371542882e-17, -1.2649106048711768e-25],
  [0.15610191226005554, -1.2301535790015805e-08, 3.0175617567361414e-16, -8.6338065063271469e-24],
  [0.15191605687141418, -1.4845571882915465e-08, -3.265830289949929e-16, -1.5268151962784823e-23],
  [0.14686977863311768, -4.6748995785605985e-09, -4.2942913417589961e-16, 1.328295982896899e-23],
  [0.14264500141143799, 9.1864720275225409e-09, -8.0493731559989293e-16, 1.437998766909278e-23],
  [0.1384023129940033, 9.8651167235175308e-09, -8.837306496940929e-16, 7.2953249091942152e-24],
  [0.1332872211933136, 9.9903507688736681e-10, 3.3169466107343579e-17, 2.7351440526086287e-24],
  [0.12900456786155701, -7.4612085398939598e-09, -6.212113165383437e-16, 1.8551872649897312e-24],
  [0.12470348179340363, -3.2924463155836747e-09, -7.4041201327417524e-17, 1.3246955625609024e-24],
  [0.12038381397724152, 3.3791991427278845e-09, 1.6214981996371606e-16, -6.00070673940474e-24],
  [0.11604541540145874, 3.5638392237302696e-10, -7.3542196351088785e-18, 7.794312440645008e-26],
  [0.11168810725212097, 3.1367659580894269e-09, -8.9944062932382251e-19, -7.9209375581822066e-26],
  [0.10731174051761627, -4.728527791542092e-09, -4.2976339455270984e-16, 5.3511432872581071e-24],
  [0.10291612148284912, 2.8332007850906393e-09, 4.9257427572340523e-17, 2.794436810397303e-24],
  [0.098501101136207581, 4.9707251648101192e-09, 4.1305127568470488e-16, 6.3134495605958654e-25],
  [0.094066515564918518, -6.5258509707177836e-09, -1.3492816627243298e-16, -9.079650179574527e-24],
  [0.08961215615272522, 2.5369617517867482e-09, 1.6110664594961319e-16, -5.1895045044869639e-24],
  [0.086034342646598816, -5.3047957138119273e-09, 5.127575488441481e-17, 1.4636155456921331e-24],
  [0.081543982028961182, 2.0112156384755053e-09, 8.0657693315776084e-17, -3.0150319017810437e-24],
  [0.077033370733261108, 5.7495661565098999e-09, -2.5038510973029852e-16, -1.8461430930405081e-23],
  [0.07250232994556427, 1.177662634077592e-09, -3.5254768579255061e-17, 1.3164077898906505e-24],
  [0.068862661719322205, -7.043545302565235e-09, 2.4971240675150099e-16, 1.0686882487619963e-23],
  [0.064294353127479553, -2.4220820904474749e-09, -2.0555896149129847e-16, 8.602907613530545e-24],
  [0.0606246218085289, 7.9059432611661151e-12, -8.2704433454710956e-19, -2.3533820836754142e-26],
  [0.056018441915512085, -5.1397452960344481e-10, -3.8116515713668017e-17, 1.9072195442219776e-24],
  [0.052318163216114044, -3.5574325707443677e-09, 9.1911558341453931e-17, -5.3214639734209769e-24],
  [0.04767347127199173, -1.8026349302147082e-09, 1.0329634289704177e-16, -2.2283569301283993e-24],
  [0.043942123651504517, -1.7950056996340891e-09, -5.3817402974104447e-17, -1.3996196977941442e-24],
  [0.040196798741817474, 3.8451930528538014e-10, -2.4485452721520977e-17, -7.3867690243779494e-26],
  [0.0354953333735466, -3.5901653872016936e-10, -2.0732077678669761e-17, -2.4120972165551679e-26],
  [0.0317181795835495, 6.8723504664802704e-10, -6.4304780937494731e-18, 1.3508692031871337e-25],
  [0.027926705777645111, 7.5687733858131878e-10, -4.2203158516594398e-17, 2.5347605636927818e-24],
  [0.02412080392241478, -1.1255707477175747e-09, 4.89700584100947e-17, 1.4172214525647275e-24],
  [0.019342962652444839, 1.9068610579431322e-10, -1.0635946218849709e-17, -5.3004895424577344e-25],
  [0.015504186972975731, -4.3701048335620385e-10, 6.6110615476371497e-18, 2.5398086818405174e-25],
  [0.011650616303086281, 9.1688900916153671e-10, -1.5848697818454755e-17, -1.350491609984469e-24],
  [0.0077821407467126846, -3.0465774347732122e-10, 7.7934359967622851e-18, 4.6601001482083692e-25],
  [0.0038986406289041042, -2.1324678134426733e-10, 1.2541658163801307e-19, 8.7450354317401229e-27],
  [0, 0, 0, 0]
];

function ADD1(d: number, yh: number, yl: number): {yh: number, yl: number} {
  const d1: number = Math.floor(d + 0.5);
  const d2: number = d - d1; // in [-.5,.5)
  return {yh: yh + d1, yl: yl + d2};
}

/*
 * Compute x * log (x / M) + (M - x)
 * aka -x * log1pmx ((M - x) / x)
 *
 * Deliver the result back in two parts, *yh and *yl.
 */
export default function ebd0(x: number, M: number): {yh: number, yl: number} {
  const Sb: number = 10;
  const S: number = 1 << Sb;
  const N: number = 128;
  let yh: number = 0, yl: number = 0;

  if (x === M) {
    return {yh: 0, yl: 0};
  }
  if (x === 0) {
    return {yh: M, yl: 0};
  }
  if (M === 0) {
    return {yh: Number.POSITIVE_INFINITY, yl: 0};
  }
  if (M / x === Number.POSITIVE_INFINITY) {
    return {yh: M, yl: 0};
  }

  let {mantissa: r, exponent: e} = frexp(M / x);

  if (Math.LN2 * -e > 1 + Number.MAX_VALUE / x) {
    return {yh: Number.POSITIVE_INFINITY, yl: 0};
  }

  let i: number = Math.floor((r - 0.5) * (2 * N) + 0.5)
  let f: number = Math.floor(S / (0.5 + i / (2.0 * N)) + 0.5)
  let fg: number = ldexp(f, -(e + Sb));

  if (fg === Number.POSITIVE_INFINITY) {
    return {yh: Number.POSITIVE_INFINITY, yl: 0};
  }

  ({yh, yl} = ADD1(-x * log1pmx ((M * fg - x) / x), yh, yl));

  if (fg === 1) {
    return {yh: yh, yl: yl};
  }

  for (let j: number = 0; j < 4; j++) {
    ({yh, yl} = ADD1(x * bd0_scale[i][j], yh, yl));
    ({yh, yl} = ADD1(-x * bd0_scale[0][j] * e, yh, yl));
    if (!Number.isFinite(yh)) {
      return { yh: Number.POSITIVE_INFINITY, yl: 0};
    }
  }

  ({yh, yl} = ADD1(M, yh, yl));
  ({yh, yl} = ADD1(-M * fg, yh, yl));
  return {yh: yh, yl: yl};
}
